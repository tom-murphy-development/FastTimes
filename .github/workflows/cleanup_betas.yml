name: Cleanup Old Betas

on:
  workflow_dispatch:
  workflow_run:
    workflows: ["Release Playstore", "Release FOSS"]
    types:
      - completed

jobs:
  cleanup:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || (github.event.workflow_run.conclusion == 'success')
    permissions:
      contents: write
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Cleanup Old Beta Releases
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Fetching list of all releases for ${{ github.repository }}..."
          # We specify the repo explicitly to avoid 'not a git repository' issues if checkout is shallow or missing
          releases=$(gh release list --repo ${{ github.repository }} --limit 100 --json tagName,isPrerelease)
          
          # Debug: Show what we found
          echo "Full release list found:"
          echo "$releases" | jq -r '.[] | "\(.tagName) (Pre-release: \(.isPrerelease))"'
          
          # Filter for pre-releases
          beta_tags=$(echo "$releases" | jq -r '.[] | select(.isPrerelease == true) | .tagName')
          
          if [ -z "$beta_tags" ]; then
            echo "No pre-releases identified by the 'isPrerelease' flag."
            # Fallback: check for tags containing 'beta'
            beta_tags=$(echo "$releases" | jq -r '.[] | .tagName' | grep "beta" || true)
            if [ -z "$beta_tags" ]; then
              echo "No releases with 'beta' in the tag name found either."
              exit 0
            fi
            echo "Found beta releases by tag name fallback:"
            echo "$beta_tags"
          fi

          for flavor in "playstore" "foss"; do
            echo "Processing $flavor flavor..."
            # Match tags like v1.0.0-foss-beta.1 or v1.0.0-playstore-beta.1
            flavor_tags=$(echo "$beta_tags" | grep "$flavor" | grep "beta" || true)
            
            if [ -n "$flavor_tags" ]; then
              # Keep the first one (most recent), delete the rest
              # 'gh release list' returns them newest-first by default
              echo "Tags found for $flavor: $(echo $flavor_tags | xargs)"
              
              echo "$flavor_tags" | tail -n +2 | while read -r tag; do
                if [ -n "$tag" ]; then
                  echo "Deleting old $flavor beta: $tag"
                  gh release delete "$tag" --repo ${{ github.repository }} --yes --cleanup-tag
                fi
              done
            else
              echo "No matches for $flavor"
            fi
          done
